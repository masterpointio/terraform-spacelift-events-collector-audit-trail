# Spacelift Audit Trail Events Collector with AWS

Terraform module setting up a collector that receives Audit Trail events sent by Spacelift and stores them in AWS S3. This is a fork from [Spacelift's example module](https://github.com/spacelift-io-examples/terraform-aws-spacelift-events-collector) maintained by Masterpoint.

## Usage

```hcl
module "collector" {
  source = "git::https://github.com/masterpointio/terraform-spacelift-events-collector-audit-trail.git?ref=v1.0.0"

	# Add inputs described below as needed
}
```

## Architecture

The main resources for this module are:

- **Courier**: A Lambda function that exposes a URL (see the `courier_url` output) and forwards incoming events to a Kinesis Firehose Delivery Stream.
- **Stream**: A Kinesis Firehose Delivery Stream that buffers events forwarded by the Courier and eventually sends them in batches to the Storage.
- **Storage**: An S3 bucket that stores the events (see the `storage_bucket_name` output).

![Spacelift Audit Trail Events Collector with AWS - Lucidchart](https://lucid.app/publicSegments/view/ecfc1313-c639-4ed2-8ca7-2397ebae86fe/image.png)

<!-- BEGIN_TF_DOCS -->

## Requirements

| Name    | Version   |
| ------- | --------- |
| archive | ~> 2.2    |
| aws     | >= 5.51.1 |
| random  | ~> 3.1    |

## Inputs

| Name                             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Default                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Required |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------: |
| additional_tag_map               | Additional key-value pairs to add to each map in `tags_as_list_of_maps`. Not added to `tags` or `id`.<br/>This is for some rare cases where resources want additional configuration of tags<br/>and therefore take a list of maps with tag key, value, and additional configuration.                                                                                                                                                                                                                                                                                                                                                                                            | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| attributes                       | ID element. Additional attributes (e.g. `workers` or `cluster`) to add to `id`,<br/>in the order they appear in the list. New attributes are appended to the<br/>end of the list. The elements of the list are joined by the `delimiter`<br/>and treated as a single ID element.                                                                                                                                                                                                                                                                                                                                                                                                | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| buffer_interval                  | Buffer incoming data for the specified period of time, in seconds, before delivering it to the destination                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `300`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |    no    |
| buffer_size                      | Buffer incoming events to the specified size, in MBs, before delivering it to the destination                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `5`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |    no    |
| cloudwatch_logs_retention_days   | Keep the Cloudwatch logs of the infrastructure (Lambdas & Kinesis Firehose) for this number of days.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `14`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| context                          | Single object for setting entire context at once.<br/>See description of individual variables for details.<br/>Leave string and numeric variables as `null` to use default value.<br/>Individual variable settings (non-null) override settings in context object,<br/>except for attributes, tags, and additional_tag_map, which are merged.                                                                                                                                                                                                                                                                                                                                   | `any`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | <pre>{<br/> "additional_tag_map": {},<br/> "attributes": [],<br/> "delimiter": null,<br/> "descriptor_formats": {},<br/> "enabled": true,<br/> "environment": null,<br/> "id_length_limit": null,<br/> "label_key_case": null,<br/> "label_order": [],<br/> "label_value_case": null,<br/> "labels_as_tags": [<br/> "unset"<br/> ],<br/> "name": null,<br/> "namespace": null,<br/> "regex_replace_chars": null,<br/> "stage": null,<br/> "tags": {},<br/> "tenant": null<br/>}</pre> |    no    |
| delimiter                        | Delimiter to be used between ID elements.<br/>Defaults to `-` (hyphen). Set to `""` to use no delimiter at all.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| descriptor_formats               | Describe additional descriptors to be output in the `descriptors` output map.<br/>Map of maps. Keys are names of descriptors. Values are maps of the form<br/>`{<br/>   format = string<br/>   labels = list(string)<br/>}`<br/>(Type is `any` so the map values can later be enhanced to provide additional options.)<br/>`format` is a Terraform format string to be passed to the `format()` function.<br/>`labels` is a list of labels, in order, to pass to `format()` function.<br/>Label values will be normalized before being passed to `format()` so they will be<br/>identical to how they appear in `id`.<br/>Default is `{}` (`descriptors` output will be empty). | `any`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| enabled                          | Set to false to prevent the module from creating any resources                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| environment                      | ID element. Usually used for region e.g. 'uw2', 'us-west-2', OR role 'prod', 'staging', 'dev', 'UAT'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| id_length_limit                  | Limit `id` to this many characters (minimum 6).<br/>Set to `0` for unlimited length.<br/>Set to `null` for keep the existing setting, which defaults to `0`.<br/>Does not affect `id_full`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| label_key_case                   | Controls the letter case of the `tags` keys (label names) for tags generated by this module.<br/>Does not affect keys of tags passed in via the `tags` input.<br/>Possible values: `lower`, `title`, `upper`.<br/>Default value: `title`.                                                                                                                                                                                                                                                                                                                                                                                                                                       | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| label_order                      | The order in which the labels (ID elements) appear in the `id`.<br/>Defaults to ["namespace", "environment", "stage", "name", "attributes"].<br/>You can omit any of the 6 labels ("tenant" is the 6th), but at least one must be present.                                                                                                                                                                                                                                                                                                                                                                                                                                      | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| label_value_case                 | Controls the letter case of ID elements (labels) as included in `id`,<br/>set as tag values, and output by this module individually.<br/>Does not affect values of tags passed in via the `tags` input.<br/>Possible values: `lower`, `title`, `upper` and `none` (no transformation).<br/>Set this to `title` and set `delimiter` to `""` to yield Pascal Case IDs.<br/>Default value: `lower`.                                                                                                                                                                                                                                                                                | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| labels_as_tags                   | Set of labels (ID elements) to include as tags in the `tags` output.<br/>Default is to include all labels.<br/>Tags with empty values will not be included in the `tags` output.<br/>Set to `[]` to suppress all generated tags.<br/>**Notes:**<br/> The value of the `name` tag, if included, will be the `id`, not the `name`.<br/> Unlike other `null-label` inputs, the initial setting of `labels_as_tags` cannot be<br/> changed in later chained modules. Attempts to change it will be silently ignored.                                                                                                                                                                | `set(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <pre>[<br/> "default"<br/>]</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                     |    no    |
| lambda_logs_verbose              | Include debug information in the Lambdas processing logs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |    no    |
| name                             | ID element. Usually the component or solution name, e.g. 'app' or 'jenkins'.<br/>This is the only ID element not also included as a `tag`.<br/>The "name" tag is set to the full `id` string. There is no tag with the value of the `name` input.                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| namespace                        | ID element. Usually an abbreviation of your organization name, e.g. 'eg' or 'cp', to help ensure generated IDs are globally unique                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| python_version                   | AWS Lambda Python runtime version                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `"3.9"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |    no    |
| regex_replace_chars              | Terraform regular expression (regex) string.<br/>Characters matching the regex will be removed from the ID elements.<br/>If not set, `"/[^a-zA-Z0-9-]/"` is used to remove all characters other than hyphens, letters and digits.                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| s3_lifecycle_configuration_rules | A list of lifecycle V2 rules for the S3 bucket where the audit trail events are stored. See example usage https://github.com/cloudposse/terraform-aws-s3-bucket or on AWS docs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <pre>list(object({<br/> enabled = optional(bool, true)<br/> id = string<br/><br/> abort_incomplete_multipart_upload_days = optional(number)<br/><br/> # `filter_and` is the `and` configuration block inside the `filter` configuration.<br/> # This is the only place you should specify a prefix.<br/> filter_and = optional(object({<br/> object_size_greater_than = optional(number) # integer >= 0<br/> object_size_less_than = optional(number) # integer >= 1<br/> prefix = optional(string)<br/> tags = optional(map(string), {})<br/> }))<br/> expiration = optional(object({<br/> date = optional(string) # string, RFC3339 time format, GMT<br/> days = optional(number) # integer > 0<br/> expired_object_delete_marker = optional(bool)<br/> }))<br/> noncurrent_version_expiration = optional(object({<br/> newer_noncurrent_versions = optional(number) # integer > 0<br/> noncurrent_days = optional(number) # integer >= 0<br/> }))<br/> transition = optional(list(object({<br/> date = optional(string) # string, RFC3339 time format, GMT<br/> days = optional(number) # integer > 0<br/> storage_class = optional(string)<br/> # string/enum, one of GLACIER, STANDARD_IA, ONEZONE_IA, INTELLIGENT_TIERING, DEEP_ARCHIVE, GLACIER_IR.<br/> })), [])<br/><br/> noncurrent_version_transition = optional(list(object({<br/> newer_noncurrent_versions = optional(number) # integer >= 0<br/> noncurrent_days = optional(number) # integer >= 0<br/> storage_class = optional(string)<br/> # string/enum, one of GLACIER, STANDARD_IA, ONEZONE_IA, INTELLIGENT_TIERING, DEEP_ARCHIVE, GLACIER_IR.<br/> })), [])<br/> }))</pre> | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| secret                           | Secret to be expected by the collector                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| stage                            | ID element. Usually used to indicate role, e.g. 'prod', 'staging', 'source', 'build', 'test', 'deploy', 'release'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| tags                             | Additional tags (e.g. `{'BusinessUnit': 'XYZ'}`).<br/>Neither the tag keys nor the tag values will be modified by this module.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| tenant                           | ID element \_(Rarely used, not included by default)\_. A customer identifier, indicating who this instance of a resource is for                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |

## Outputs

| Name                            | Description                                       |
| ------------------------------- | ------------------------------------------------- |
| audit_trail_storage_bucket_name | The name for the S3 bucket that stores the events |
| courier_function_arn            | The ARN for the Lambda function for the courier   |
| courier_url                     | The HTTP URL endpoint for the courier             |
| stream_name                     | The name for the Kinesis Firehose Delivery Stream |

<!-- END_TF_DOCS -->
